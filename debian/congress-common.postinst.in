#!/bin/sh

set -e

CONF=/etc/congress/congress.conf

#PKGOS-INCLUDE#

if [ "$1" = "configure" ] || [ "$1" = "reconfigure" ] ; then
	. /usr/share/debconf/confmodule
	. /usr/share/dbconfig-common/dpkg/postinst

	pkgos_var_user_group congress

	pkgos_write_new_conf congress congress.conf
	pkgos_write_new_conf congress api-paste.ini
	pkgos_write_new_conf congress policy.json
	db_get congress/configure_db
	if [ "$RET" = "true" ]; then
		pkgos_dbc_postinst ${CONF} database connection congress $@
	fi
	pkgos_write_admin_creds ${CONF} keystone_authtoken congress
	db_get congress/volume_group
	if [ -n "${RET}" ] ; then
		pkgos_inifile set ${CONF} DEFAULT volume_group ${RET}
	fi

	db_get congress/configure_db
	if [ "$RET" = "true" ]; then
		echo "Now calling congress-db-manage sync: this may take a while..."
		su -s /bin/sh -c 'congress-db-manage sync' congress
	fi
	db_stop
fi

#DEBHELPER#

exit 0
